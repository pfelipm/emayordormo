![](https://user-images.githubusercontent.com/12829262/126078672-8b8ea2a7-43aa-4f69-8211-74c8798f432d.png)

# Tabla de contenidos

*   [¬øQu√© es eMayordormo?](#qu%C3%A9-es-emayordormo)
*   [¬øC√≥mo funciona eMayordomo?](#c%C3%B3mo-funciona-emayordomo)
*   [La hoja de c√°lculo](#la-hoja-de-c%C3%A1lculo)
    *   [Pesta√±a üîÄ Reglas](#pesta%C3%B1a--reglas)
    *   [Pesta√±a üóíÔ∏è Registro](#pesta%C3%B1a-%EF%B8%8F-registro)
*   [Implementaci√≥n](#implementaci%C3%B3n)
    *   [Diagrama de bloques](#diagrama-de-bloques)
    *   [acercaDe.html](#acercadehtml)
    *   [Activador.gs](#activadorgs)
        *   [comprobarEstado()](#comprobarEstado)
        *   [activar()](#activar)
        *   [desactivar()](#desactivar)
        *   [gestionarTrigger()](#gestionarTrigger)
    *   [C√≥digo.gs](#c%C3%B3digogs)
        *   [onOpen()](#onopen)
        *   [construirMenu()](#construirmenu)
        *   [acercaDe()](#acercade)
        *   [ejecutarManualmente()](#ejecutarManualmente)
        *   [procesarEmails()](3procesarEmails)
        *   [etiquetasMensaje()](#etiquetasMensaje)
        *   [duplicarBorradorAPI()](#duplicarborradorapi-y-extraerelementos)
*   [Mejoras y reflexiones finales](#mejoras-y-reflexiones-finales)
*   [Licencia](#licencia)

# ¬øQu√© es eMayordormo?

**eMayordomo** es un script desarrollado con el objetivo de vigilar un buz√≥n de Gmail para **responder autom√°ticamente a ciertos mensajes con respuestas predise√±adas espec√≠ficas**. Este documento recoge informaci√≥n t√©cnica sobre su funcionamiento, limitaciones y algunos detalles de implementaci√≥n que tal vez resulten de tu inter√©s.

![](https://user-images.githubusercontent.com/12829262/122110114-7740ac80-ce1e-11eb-96b4-70304088d53b.gif)

Si simplemente deseas utilizarlo cuanto antes, puedes averiguar r√°pidamente c√≥mo usarlo y obtener una copia de la plantilla de hoja de c√°lculo en la que se basa en este art√≠culo en mi blog:

[üëâ https://pablofelip.online/emayordomo üëà](https://pablofelip.online/emayordomo)

Si por el contrario prefieres conocer esos detalles t√©cnicos que mencionaba, este es el lugar adecuado.

L√≥gicamente tambi√©n puedes hacer ambas cosas, lo que por otra parte es lo m√°s recomendable, en mi opini√≥n.

# ¬øC√≥mo funciona eMayordomo?

En el art√≠culo mencionado anteriormente se facilitan las [especificaciones](https://pablofelip.online/emayordomo/#mcetoc_1f7masso32l) de eMayordomo para a continuaci√≥n detallar [c√≥mo se han llegado a satisfacer](https://pablofelip.online/emayordomo/#mcetoc_1f7m9lbio2h). No obstante, repasemos el funcionamiento general del script para centrar la discusi√≥n antes de abordar algunos de los aspectos t√©cnicos de su implementaci√≥n.

![Esquema funcional](https://docs.google.com/drawings/d/e/2PACX-1vS6_mjaL-sZabk3piQYjGwOQWytUsRRnmE-Khrijj5hs_A8ivxCeO0tha1YKW4wGKnQXS0BXVTA8PIp/pub?w=1000&h=1000)

1.  Un usuario rellena un formulario web de contacto.
2.  El formulario env√≠a una notificaci√≥n por correo electr√≥nico a un buz√≥n de Gmail.
3.  El correo entrante es clasificando utilizado los filtros de Gmail. Se aplican etiquetas diferenciadoras y se marcan los mensajes como destacados ‚≠ê para indicar que a√∫n no han sido respondidos.
4.  Cada una de las etiquetas anteriores llevar√° asociada una respuesta predefinida. Estas respuestas se construyen a partir de una serie de mensajes en borrador, en cuyo asunto se utilizan prefijos distintivos, siempre entre corchetes y con un espacio posterior para que el script pueda identificarlos con facilidad.
5.  Para establecer los emparejamientos (etiqueta, borrador) se recurre a una tabla de reglas en una hoja de c√°lculo de Google, en la que a cada etiqueta se le asocia uno de los prefijos utilizados en los asuntos de los borradores.
6.  Cada regla cuenta, opcionalmente, con una expresi√≥n regular para extraer la direcci√≥n de email a la que se debe responder del propio contenido del mensaje.
7.  La hoja de c√°lculo dispone de un men√∫ espec√≠fico para el script que permite activarlo, es decir, instalar un [activador (_trigger_) instalable](https://developers.google.com/apps-script/guides/triggers/installable) que corre cada hora,o ejecutarlo manualmente. No se ha contemplado la posibilidad de que el usuario pueda seleccionar otras periodicidades.
8.  Cada vez que eMayordomo procesa el buz√≥n de correo registra el resultado de todos los intentos de env√≠o de respuestas en una tabla situada en otra pesta√±a de la hoja de c√°lculo. Esta informaci√≥n es procesada por un conjunto de f√≥rmulas para obtener m√©tricas de procesamiento para cada par etiqueta / borrador.

# La hoja de c√°lculo

eMayordomo es un script que reside en una hoja de c√°lculo de Google. Esta hoja de c√°lculo, adem√°s, sirve a dos prop√≥sitos:

*   Configurar el script (pesta√±a üîÄ **Reglas**).
*   Mostrar un registro de eventos de funcionamiento (pesta√±a üóíÔ∏è **Registro**).

Aunque, evidentemente, las hojas de c√°lculo no constituyen en general el mejor modo de construir una interfaz de usuario, lo cierto es que hay unas cuantas cosas que podemos hacer para reducir la fricci√≥n cuando se utilizan como tal, un hecho extremadamente frecuente en innumerables desarrollos basados en Apps Script. Por esta raz√≥n voy a dedicar unas l√≠neas a mostrar c√≥mo algunas de sus caracter√≠sticas integradas, tales como los [intervalos protegidos](https://support.google.com/docs/answer/1218656), el [formato condicional](https://support.google.com/docs/answer/78413), la validaci√≥n de datos o incluso la inserci√≥n de notas en celdas pueden resultar de gran ayuda para al menos mejorar esta situaci√≥n.

## Pesta√±a üîÄ **Reglas**

![](https://user-images.githubusercontent.com/12829262/122110014-537d6680-ce1e-11eb-8320-d4308c526abf.png)

Las columnas `A` - `D` son las utilizadas para ajustar la configuraci√≥n del script. El resto (`E` - `H`, con encabezado de azul m√°s claro), contienen una serie de f√≥rmulas matriciales que resumen los datos contenidos en la pesta√±a de registro (a continuaci√≥n). Se ha [protegido](https://support.google.com/docs/answer/1218656?co=GENIE.Platform%3DDesktop&hl=es) el intervalo `E1:H11` para reducir la posibilidad de ediciones accidentales susceptibles de romper las f√≥rmulas. Como los permisos de edici√≥n que incluyen una lista de control de acceso con usuarios espec√≠ficos se pierden al hacer una copia de la hoja de c√°lculo, he usado en su lugar la posibilidad de mostrar una advertencia al tratar de editar el intervalo protegido, que s√≠ se mantiene.

![](https://user-images.githubusercontent.com/12829262/122237707-d5719c00-cebf-11eb-9c87-deb57cb4567d.png)

Un ajuste visual al que casi siempre recurro en mis hojas de c√°lculo para mejorar su aspecto consiste en eliminar las l√≠neas de cuadr√≠cula (`Ver` ‚áí `Eliminar las l√≠neas de cuadr√≠cula`) y activar simult√°neamente los colores alternos en las tablas de datos (`Formato` ‚áí `Colores alternos`), una combinaci√≥n de colores poco saturados para las filas alternas con otro m√°s intenso (y texto en blanco) en el encabezado suele facilitar la legibilidad de la tabla.

![](https://user-images.githubusercontent.com/12829262/122234185-f71d5400-cebc-11eb-84e4-b679a06b4db1.png)

Las casillas de verificaci√≥n en la columna `A`, que permiten desactivar selectivamente algunas reglas, podr√≠an haberse ocultado en aquellas filas vac√≠as con facilidad usando una regla de formato condicional, con las funciones [`ES.PAR()`](https://support.google.com/docs/answer/3093419) y [`ES.IMPAR()`](https://support.google.com/docs/answer/3093491), para hacer coincidir en su caso el color del texto de la celda de cada fila con el de fondo. No obstante, las casillas, aunque invisibles, siguen ah√≠ y de hacer clic dentro de la celda aparecer√≠a un desconcertante mensaje informando de su presencia.

![](https://user-images.githubusercontent.com/12829262/122235480-05b83b00-cebe-11eb-859f-33eed18bb9c7.png)

Por esa raz√≥n he optado por simplemente reducir la visibilidad de aquellas casillas de verificaci√≥n en filas en las que no se ha introducido el nombre de una etiqueta.

![](https://user-images.githubusercontent.com/12829262/122236496-da821b80-cebe-11eb-9fd0-f93a0c36da07.png)

He aplicado una nueva regla de formato condicional sobre las columnas `B` y `C` para destacar las celdas en las que falta informaci√≥n necesaria para definir completamente una regla de respuesta autom√°tica que est√© marcada como activa. La expresi√≥n regular de extracci√≥n del email es un par√°metro opcional, por tanto la columna D no se colorea. La f√≥rmula utilizada en la regla de formato es `=Y($A2=VERDADERO;ESBLANCO(B2))`.

![](https://user-images.githubusercontent.com/12829262/122237277-7ca20380-cebf-11eb-906d-fa89ef974735.png)

Se han insertado notas (`Insertar` ‚áí `Nota`) en las celdas `B1`, `C1` y `D1` con instrucciones b√°sicas de uso. Aunque las hojas de c√°lculo de Google tambi√©n admiten comentarios, l[as notas resultan m√°s convenientes](https://twitter.com/pfelipm/status/1317511665773051905) cuando no se requiere una discusi√≥n activa con el resto de usuarios que tuvieran acceso al documento.

![](https://user-images.githubusercontent.com/12829262/122239697-701eaa80-cec1-11eb-8e1b-1c39f6e6107e.gif)

Tambi√©n he utilizado la validaci√≥n de datos (`Datos` ‚áí `Validaci√≥n de datos`) para evitar reglas duplicadas sobre la misma etiqueta de correo. La f√≥rmula personalizada usada en el criterio de validaci√≥n es `=CONTAR.SI($B$2:$B;B2)=1`, lo que rechaza la introducci√≥n de cualquier secuencia de texto ya presente en el intervalo `B2:B`.

![](https://user-images.githubusercontent.com/12829262/122250606-15d61780-ceca-11eb-95b1-624782a6b0b3.png)

Finalmente, cuatro f√≥rmulas de tipo matricial ([`ARRAYFORMULA`](https://support.google.com/docs/answer/3093275)) realizan recuentos ([`CONTAR.SI.CONJUNTO`](https://support.google.com/docs/answer/3256550)) y b√∫squedas ([`BUSCARV`](https://support.google.com/docs/answer/3093318)) en la tabla de registro (pesta√±a üóíÔ∏è **Registro**, a continuaci√≥n) para calcular, para cada regla, el n¬∫ de env√≠os realizados, los que han experimentado errores y sus marcas de tiempo correspondientes. Veamos, por ejemplo, las correspondientes a los env√≠os realizados con √©xito y a la marca temporal del √∫ltimo env√≠o.

```
={"üì® Env√≠os";
  ArrayFormula(SI(ESBLANCO(B2:B);"";CONTAR.SI.CONJUNTO('üóíÔ∏è Registro'!D2:D;B2:B;'üóíÔ∏è Registro'!A2:A;"üÜó")))}
```

```
={"üì® √öltimo env√≠o";
  ArrayFormula(SI.ERROR(BUSCARV("üÜó" & B2:B;{'üóíÔ∏è Registro'!A2:A & 'üóíÔ∏è Registro'!D2:D\'üóíÔ∏è Registro'!C2:C};2;FALSO);))}
```

![](https://user-images.githubusercontent.com/12829262/122248390-53d23c00-cec8-11eb-94bb-6f0a909291b9.gif)

Estas cuatro f√≥rmulas se encuentran en la fila de encabezado y por tanto devuelven en la 1¬™ fila del resultado la etiqueta que da t√≠tulo a la columna como literal de texto . Esto resulta muy pr√°ctico, dado que de este modo es posible ordenar la tabla sin que los c√°lculos dejen de funcionar.

Y, naturalmente, estos c√°lculos podr√≠an haberse realizado en el seno del c√≥digo Apps Script, pero dado que en este caso tenemos a nuestra disposici√≥n toda la potencia que nos ofrecen las f√≥rmulas de las hojas de c√°lculo de Google ¬øpor qu√© no usarlas?¬†

## Pesta√±a üóíÔ∏è **Registro**

![](https://user-images.githubusercontent.com/12829262/122252608-c7c21380-cecb-11eb-8ad5-ad6434776eb8.png)

En esta pesta√±a se muestran ciertos eventos de funcionamiento registrados por el script, siempre m√°s arriba que incluyen:

*   Respuestas enviadas correctamente.
*   Respuestas que no han podido ser enviadas, bien por alg√∫n fallo en la configuraci√≥n de las reglas, bien por errores en tiempo de ejecuci√≥n de cualquier √≠ndole.
*   Ejecuciones programadas o manuales en las que no se han detectado correos electr√≥nicos a los que responder.

Por comodidad, los elementos m√°s recientes aparecer√°n siempre en la parte superior de la tabla, en la que se ha usado nuevamente la combinaci√≥n de colores alternos que se aplic√≥ sobre la de reglas. Cada evento lleva asociado dos marcas de tiempo, que se corresponden con:

*   El inicio de un proceso de revisi√≥n del buz√≥n de Gmail.
*   El momento en que se produce un evento espec√≠fico.

Adem√°s, se han dispuesto tres controles de filtro en la parte superior para facilitar un primer an√°lisis de los datos, aunque cabe la posibilidad, tal y como [se recomendaba en el art√≠culo previo](https://pablofelip.online/emayordomo/#mcetoc_1f829n2n14f), de llevarlos a una herramienta de visualizaci√≥n m√°s avanzada como Data Studio. Se ha ajustado el color de fondo de los controles de filtro para hacerlo coincidir con el de la fila sobre la que flotan para lograr una mejor integraci√≥n visual, aunque esto probablemente sea una man√≠a m√≠a.

# Implementaci√≥n

## Diagrama de bloques

![Diagrama de bloques](https://docs.google.com/drawings/d/e/2PACX-1vRGv92McVLaESzpO2jSc8j_gq8VO7u2lPc4A0-DUWIIq8F1hauwxLojvkZSrPG5hNUy-Y0ReclagLAy/pub?w=1000&h=1000)

## acercaDe.html

Se trata de una plantilla HTML necesaria para generar la ventana que muestra informaci√≥n sobre eMayordomo.

Se utiliza el servicio de plantillas HTML [(HTMLService](https://developers.google.com/apps-script/guides/html)) y sendos [scriptlets expl√≠citos](https://developers.google.com/apps-script/guides/html/templates#printing_scriptlets) (_printing scriptlets_) para parametrizar los elementos de texto que indican el nombre y la versi√≥n del script.

![](https://user-images.githubusercontent.com/12829262/123538857-0b701500-d737-11eb-853f-ad97d5d8b7ce.png)

```javascript
const EMAYORDOMO = {
  version: 'Versi√≥n: 1.0 (junio 2021)',
  icono: 'üì≠',
  nombre: 'eMayordomo',
  ...
};

function¬†acercaDe()¬†{
  let¬†panel¬†=¬†HtmlService.createTemplateFromFile('acercaDe');
  panel.version¬†=¬†EMAYORDOMO.version;
  panel.nombre¬†=¬†EMAYORDOMO.nombre;
  SpreadsheetApp.getUi().showModalDialog(panel.evaluate().setWidth(420).setHeight(450),¬†`${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`);
}
```

```html
<b><?=¬†nombre¬†?></b>¬†es¬†una¬†plantilla¬†de¬†hoja¬†de¬†c√°lculo¬†de¬†Google¬†que¬†permite 
administrar¬†y¬†enviar¬†mensajes¬†de¬†respuesta¬†autom√°tica,¬†con¬†HTML,¬†im√°genes¬†en¬†l√≠nea¬†y
adjuntos,¬†en¬†funci√≥n¬†de¬†las¬†etiquetas¬†aplicadas¬†a¬†los¬†correos¬†electr√≥nicos¬†recibidos
en¬†un¬†buz√≥n¬†de¬†Gmail.
...
<p><?= version ?>.</p>
```

La peque√±a imagen en la cabecera del cuadro de di√°logo se ha insertado usando un [esquema de URI de datos](https://es.wikipedia.org/wiki/Esquema_de_URI_de_datos), eludiendo as√≠ su hospedaje en un URL externo. La codificaci√≥n Base 64 se ha obtenido en el conocido sitio web [Base64 Image Encoder](https://www.base64-image.de/).

```html
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAaQAA...>
```

## Activador.gs

El modo de funcionamiento natural de eMayordomo es en 2¬∫ plano, gracias a un [activador por tiempo instalable](https://developers.google.com/apps-script/guides/triggers/installable), instanciado mediante la clase [`ClockTriggerBuilder`](https://developers.google.com/apps-script/reference/script/clock-trigger-builder), ¬†que es inicializado por el usuario con el comando ¬†`‚è∞¬†Procesar¬†etiquetas¬†cada¬†hora` del men√∫ del script.

![](https://user-images.githubusercontent.com/12829262/123541712-2b5b0500-d746-11eb-91f9-f7a00851e22c.png)

La interfaz de usuario de eMayordormo no contempla en estos momentos la posibilidad de que el usuario pueda introducir una frecuencia distinta a 1 hora para las ejecuciones peri√≥dicas del activador por tiempo, pero este valor puede ser variado f√°cilmente modificando la constante `EMAYORDOMO.horasActivador` en la secci√≥n de inicializaci√≥n de variables globales en `C√≥digo.gs`.

:warning: Cuando un script que instala _triggers_ puede ser utilizado por varios usuarios es conveniente **impedir que se activen m√∫ltiples instancias**. De lo contrario nos podemos encontrar con la situaci√≥n de que el script reacciona por duplicado ante un determinado evento, lo que probablemente puede suponer un mal funcionamiento o, como m√≠nimo, un p√©rdida de eficiencia. Esto se consigue utilizando:

*   [PropertiesService](https://developers.google.com/apps-script/guides/properties), para llevar la cuenta de la direcci√≥n de email del usuario que ha realizado la activaci√≥n del _trigger_. Un valor de `null` o `''` indica que no est√° activo. El uso de este registro es imprescindible dado que un usuario [no puede determinar](https://developers.google.com/apps-script/reference/script/script-app#getProjectTriggers()) qu√© _triggers han_ sido activados por otros, ni siquiera en el contexto de un mismo script. La informaci√≥n se guarda en el registro de **propiedades del documento**, de modo que quede compartida entre todos sus usuarios.
*   [LockService](https://developers.google.com/apps-script/reference/lock), para garantizar que no se produzcan problemas de concurrencia al modificar la propiedad que identifica al usuario que ha instalado el activador. Dado que este script no se distribuye como complemento, [`getDocumentLock()`](https://developers.google.com/apps-script/reference/lock/lock-service?hl=en#getdocumentlock) y [`getScriptLock()`](https://developers.google.com/apps-script/reference/lock/lock-service?hl=en#getscriptlock). podr√≠an utilizarse indistintamente, obteniendo en ambos casos los mismos resultados.

![](https://user-images.githubusercontent.com/12829262/123540516-ae2c9180-d73f-11eb-9b0f-e63a616eed08.png)

:point\_right: [Ver v√≠deo demostrativo en YouTube](https://youtu.be/O4HvbyFLeHw)

Adicionalmente, y dado que eMayordomo requiere que se hayan definido una serie de reglas de filtro sobre el buz√≥n de Gmail que se desea vigilar, se establece una verificaci√≥n adicional para **impedir que un usuario distinto al propietario de la hoja de c√°lculo de control instale el activador**. Se supone, por tanto, que **el propietario de ambos elementos (buz√≥n y hoja de c√°lculo) es el mismo**.

Veamos las distintas funciones involucradas en esta gesti√≥n de los activadores que se encuentran dentro de este archivo.

### comprobarEstado()

Esta funci√≥n es invocada por el comando `‚ùì Comprobar estado` del men√∫ del script.

![](https://user-images.githubusercontent.com/12829262/123541754-7248fa80-d746-11eb-9928-60ea2001c4ae.png)

Simplemente muestra un mensaje indicando si eMayordomo est√° procesando respuestas en 2¬∫ plano o no y, en su caso, qu√© usuario lo ha activado.

![](https://user-images.githubusercontent.com/12829262/123541617-bb4c7f00-d745-11eb-8458-f31f2c3bfcf5.png)

```javascript
/**
 *¬†Informa¬†del¬†estado¬†de¬†activaci√≥n¬†de¬†eMayordomo
 *¬†¬øSe¬†est√°¬†vigilando¬†el¬†buz√≥n¬†de¬†Gmail¬†en¬†2¬∫¬†plano?
 */
 function¬†comprobarEstado()¬†{

   const¬†ssUi¬†=¬†SpreadsheetApp.getUi();
   const¬†activadoPor¬†=¬†PropertiesService.getDocumentProperties().getProperty(EMAYORDOMO.propActivado);
   if¬†(!activadoPor)¬†{
 ¬†¬†  mensaje¬†=¬†`No¬†se¬†est√°¬†vigilando¬†el¬†buz√≥n¬†de¬†Gmail¬†en¬†2¬∫¬†plano.`;
 ¬† }¬†else¬†{
 ¬†¬†  mensaje¬†=¬†`El¬†proceso¬†en¬†2¬∫¬†plano¬†ha¬†sido¬†activado¬†por¬†${activadoPor}
 ¬†¬†¬† y¬†se¬†est√°¬†vigilando¬†su¬†buz√≥n¬†de¬†Gmail.`;
 ¬† }
   ssUi.alert(
 ¬†¬†  `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
 ¬†¬†  mensaje,
 ¬†¬†  ssUi.ButtonSet.OK);
 ¬†¬†  
   //¬†Se¬†ejecuta¬†siempre¬†para¬†sincronizar¬†estado¬†del¬†men√∫¬†cuanto¬†antes¬†cuando¬†hay¬†varias¬†instancias¬†abiertas¬†de¬†la¬†hdc
   construirMenu(PropertiesService.getDocumentProperties().getProperty(EMAYORDOMO.propActivado));¬†¬† 

}
```

La funci√≥n siempre actualiza el men√∫ del script antes de finalizar su ejecuci√≥n para que este refleje su estado de activaci√≥n tan pronto como sea posible en un escenario multi usuario.

### activar()

Esta funci√≥n es invocada al utilizar el comando `‚è∞ Procesar etiquetas cada hora` del men√∫ del script.

![](https://user-images.githubusercontent.com/12829262/123542152-3f076b00-d748-11eb-8762-eda619d51fb4.png)

La l√≥gica del control tiene en cuenta las circunstancias ya descritas, que pueden combinarse entre s√≠ de distintos modos, para evitar tanto activaciones m√∫ltiples como que un usuario distinto al propietario de la hoja de c√°lculo realice la instalaci√≥n del _trigger_ (cuando sea posible comprobarlo, claro est√°).

Primeramente se comprueba si ya hay un _trigger_ activo. De ser as√≠ se cancela la activaci√≥n.

```javascript
/**
 * Men√∫ >> Activar
 * Trata de impedir que un usuario distinto al propietario de la hdc active el trigger,
 * esto es una medida de seguridad para evitar que eMayordomo act√∫e sobre el buz√≥n de
 * Gmail incorrecto. La comprobaci√≥n no es concluyente cuando la hdc reside en una
 * unidad compartida, en ese caso se solicita confirmaci√≥n al usuario.
 */
function activar() {

  const ssUi = SpreadsheetApp.getUi();
  let emailPropietario;
  let activar = true;
  const activadoPor = PropertiesService.getDocumentProperties().getProperty(EMAYORDOMO.propActivado);

  //¬†[1]¬†Cancelar¬†si¬†ya¬†est√°¬†activado
  if¬†(activadoPor)¬†{
¬†   ssUi.alert(
 ¬†  `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
 ¬†  `${EMAYORDOMO.simboloError}¬†Ya¬†hay¬†un¬†proceso¬†en¬†2¬∫¬†plano¬†activado¬†por¬†${activadoPor}.`,
 ¬†  ssUi.ButtonSet.OK);
```

¬†A continuaci√≥n se trata de identificar al propietario de la hoja de c√°lculo.

```javascript
  }¬†else¬†{
¬†¬†  //¬†No¬†hay¬†proceso¬†en¬†2¬∫¬†plano¬†activo,¬†veamos¬†qui√©n¬†es¬†el¬†propietario¬†de¬†la¬†hdc
¬†¬†  const¬†propietario¬†=¬†SpreadsheetApp.getActiveSpreadsheet().getOwner();
¬†¬†  const¬†emailUsuarioActivo¬†=¬†Session.getEffectiveUser().getEmail();
¬†¬†  if¬†(propietario)¬†{
¬†¬†¬†¬†  emailPropietario¬†=¬†propietario.getEmail();
¬†¬†¬† }¬†else¬†{
¬†¬†¬†¬†  emailPropietario¬†=¬†null;
¬†¬†¬† }
```

Esta comprobaci√≥n, no obstante, :warning: [no puede realizarse](https://twitter.com/pfelipm/status/1404186554378108931) :warning: **cuando la hoja de c√°lculo reside en una unidad compartida**. En esta circunstancia, eMayordomo informar√° al usuario y solicitar√° su confirmaci√≥n antes de poner en marcha el activador por tiempo.

![Imagen](https://pbs.twimg.com/media/E3yppjMWQAEzcgZ?format=png&name=900x900)

```javascript
    //¬†[2]¬†Si¬†la¬†hdc¬†est√°¬†en¬†unidad¬†compartida¬†solicitar¬†confirmaci√≥n¬†para¬†proseguir¬†o¬†cancelar¬†activaci√≥n
 ¬†¬† if¬†(!emailPropietario)¬†{
 ¬†¬†¬†¬† activar¬†=¬†ssUi.alert(
 ¬†¬†¬†¬†¬†¬† `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
 ¬†¬†¬†¬†¬†¬† `Solo¬†el¬†propietario¬†del¬†buz√≥n¬†de¬†Gmail¬†en¬†el¬†que¬†se¬†han¬†definido¬†las¬†reglas¬†de
 ¬†¬†¬†¬†¬†¬†¬†filtrado,¬†etiquetas¬†y¬†borradores¬†debe¬†realizar¬†la¬†activaci√≥n¬†en¬†2¬∫¬†plano.
 ¬†¬†¬†¬†¬†¬† 
 ¬†¬†¬†¬†¬†¬†¬†¬øSeguro¬†que¬†deseas¬†continuar?`,
 ¬†¬†¬†¬†¬†¬† ssUi.ButtonSet.OK_CANCEL)¬†==¬†ssUi.Button.OK;
 ¬†¬†¬†¬† if¬†(!activar)¬†{
 ¬†¬†¬†¬†¬†¬† ssUi.alert(
 ¬†¬†¬†¬†¬†¬†¬†¬† `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
 ¬†¬†¬†¬†¬†¬†¬†¬† `Activaci√≥n¬†en¬†2¬∫¬†plano¬†cancelada.`,
 ¬†¬†¬†¬†¬†¬†¬†¬† ssUi.ButtonSet.OK);
 ¬†¬†¬†¬†¬†}
```

Si el usuario actual del script no es quien realiz√≥ la activaci√≥n, el proceso finaliza con un mensaje de alerta.

```javascript
 ¬†¬†¬†}¬†else¬†if¬†(emailPropietario¬†!=¬†emailUsuarioActivo)¬†{
 ¬†¬†¬†¬† //¬†[3]¬†Cancelar¬†activaci√≥n¬†si¬†se¬†puede¬†determinar¬†que¬†el¬†usuario¬†actual¬†no¬†es¬†el¬†propietario¬†de¬†la¬†hdc
 ¬†¬†¬†¬† ssUi.alert(
 ¬†¬†¬†¬† `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
 ¬†¬†¬†¬† `${EMAYORDOMO.simboloError}¬†Solo¬†${emailPropietario}¬†debe¬†activar¬†el¬†proceso¬†en¬†2¬∫¬†plano.`,
 ¬†¬†¬†¬† ssUi.ButtonSet.OK);
 ¬†¬†¬†¬† activar¬†=¬†false;
 ¬†¬†¬†}
```

De ser as√≠ se procede, en su caso, a tratar de poner en marcha el activador por tiempo, obteniendo previamente un acceso exclusivo a la secci√≥n de c√≥digo cr√≠tica por medio de [`getDocumentLock()`](https://developers.google.com/apps-script/reference/lock/lock-service?hl=en#getDocumentLock()) y [`waitLock(1)`](https://developers.google.com/apps-script/reference/lock/lock?hl=en#waitLock(Integer)), que fallar√° inmediatamente con una excepci√≥n, capturada por el bloque [`try...catch`](https://developer.mozilla.org/es/docs/Web/JavaScript/Reference/Statements/try...catch) si otra instancia del script estuviera tratando de realizar tambi√©n la activaci√≥n en ese mismo instante.

```javascript
    // [4] Continuamos con activaci√≥n a menos que se haya cancelado en [2] o [3]
    if (activar) {

      // Solo gestionaremos el activador si no hay otra instancia del script ya intent√°ndolo
      const mutex = LockService.getDocumentLock();
      try {

        // Queremos fallar cuanto antes
        mutex.waitLock(1);
```

Si el script consigue acceder al bloque de c√≥digo protegido por el sem√°foro de acceso, invocar√° a continuaci√≥n `gestionarTrigger('ON')` para instalar el activador. Si la llamada tiene √©xito se escribe la direcci√≥n de email del usuario que ha conseguido ejecutar este procedimiento en la propiedad del documento indicada por la constante de texto `EMAYORDOMO.propActivado`.¬†

En caso contrario, o si se ha producido alg√∫n otro error en tiempo de ejecuci√≥n, se emiten las alertas correspondientes.

```javascript
        const resultado = gestionarTrigger('ON');
        let mensaje;    
        if (resultado == 'OK') {
          mensaje = `Vigilando ahora el buz√≥n de Gmail de ${emailUsuarioActivo}.`;
          PropertiesService.getDocumentProperties().setProperty(EMAYORDOMO.propActivado, emailUsuarioActivo);
        } else {
          mensaje = `${EMAYORDOMO.simboloError} Se ha producido un error en la activaci√≥n del proceso en 2¬∫ plano: 

          ${resultado}`;
        }

        // Aqu√≠ termina la secci√≥n cr√≠tica cuando se intenta realizar activaci√≥n
        mutex.releaseLock();

        ssUi.alert(
          `${EMAYORDOMO.icono} ${EMAYORDOMO.nombre}`,
          mensaje,
          ssUi.ButtonSet.OK);

      } catch(e) {
           // No ha sido posible obtener acceso al bloque de c√≥digo exclusivo
        ssUi.alert(
          `${EMAYORDOMO.icono} ${EMAYORDOMO.nombre}`,
          `${EMAYORDOMO.simboloError} En este momento no es posible activar el proceso en 2¬∫ plano, int√©ntalo m√°s tarde.`,
          ssUi.ButtonSet.OK);
      }
    }
  }
```

Antes de terminar, se actualiza nuevamente el men√∫ del script para reflejar el cambio en el primer comando, que ahora se transformar√° en `‚è∏Ô∏è Dejar de procesar etiquetas cada hora` siempre y cuando la activaci√≥n del _trigger_ se haya realizado del modo esperado.

```javascript
  //¬†Se¬†ejecuta¬†siempre¬†para¬†sincronizar¬†estado¬†del¬†men√∫¬†cuanto¬†antes¬†cuando¬†hay¬†varias¬†instancias¬†abiertas¬†de¬†la¬†hdc
  construirMenu(PropertiesService.getDocumentProperties().getProperty(EMAYORDOMO.propActivado));

}
```

Como puedes apreciar, se emiten numerosas alertas visibles con el m√©todo [`alert(title, prompt, buttons)`](https://developers.google.com/apps-script/reference/base/ui.html?hl=en#alert(String,String,ButtonSet)) para mostrar lo que est√° ocurriendo en cada momento a lo largo del proceso.

### desactivar()

Esta funci√≥n, complementaria de la anterior, es invocada por el comando `‚è∏Ô∏è Dejar de procesar etiquetas cada hora` del men√∫ del script y trata de eliminar un _trigger_ previamente activado, teniendo en cuenta todas las consideraciones acerca de la casu√≠stica de concurrencia mencionadas.

![](https://user-images.githubusercontent.com/12829262/123549669-3889eb00-d76a-11eb-8e82-578ec15df79c.png)

Nuevamente se utiliza un bloque de ejecuci√≥n en exclusi√≥n mutua para acceder a la propiedad del documento `EMAYORDOMO.propActivado`. Si el usuario que ejecuta la funci√≥n es el mismo que realiz√≥ previamente la activaci√≥n, se invoca inmediatamente `gestionarTrigger('OFF')`, controlando como siempre los posibles errores en tiempo de ejecuci√≥n en todo momento mediante un bloque [`try...catch`](https://developer.mozilla.org/es/docs/Web/JavaScript/Reference/Statements/try...catch).

```javascript
/**
 * Men√∫ >> Desactivar
 * Trata de eliminar el trigger de tratamiento de respuestas (un usuario nunca tiene acceso a los triggers de otro)
 */
function desactivar() {

  const ssUi = SpreadsheetApp.getUi();
  const mutex = LockService.getDocumentLock();
  try {

     // Queremos fallar cuanto antes
    mutex.waitLock(1);

    const activadoPor = PropertiesService.getDocumentProperties().getProperty(EMAYORDOMO.propActivado);

    if (activadoPor == Session.getEffectiveUser()) {

      const resultado = gestionarTrigger('OFF');
      let mensaje;
      if (resultado == 'OK') {     
        mensaje = `Ya no se est√° vigilando el buz√≥n de Gmail de ${activadoPor}.`;
        PropertiesService.getDocumentProperties().setProperty(EMAYORDOMO.propActivado, '');
      } else {
        mensaje = `${EMAYORDOMO.simboloError} Se ha producido un error al desactivar el proceso en 2¬∫ plano: 

        ${resultado}`;
      } 

      // Aqu√≠ termina la secci√≥n cr√≠tica cuando se intenta realizar desactivaci√≥n
      mutex.releaseLock();

      ssUi.alert(
        `${EMAYORDOMO.icono} ${EMAYORDOMO.nombre}`,
        mensaje,
        ssUi.ButtonSet.OK);
```

En caso contrario, simplemente se muestra una alerta informativa.

```javascript
 ¬†¬† }¬†else¬†{
 ¬†¬† ¬†¬†¬† 
 ¬†¬†   //¬†Aqu√≠¬†termina¬†la¬†secci√≥n¬†cr√≠tica¬†cuando¬†*no*¬†se¬†realiza¬†desactivaci√≥n¬†porque¬†lo¬†ha¬†activado¬†otro¬†usuario¬†o¬†no¬†est√°¬†activado
 ¬†¬†¬†¬† mutex.releaseLock();

 ¬†¬†¬†¬† if¬†(!activadoPor)¬†{
 ¬†¬†¬†¬†¬†¬† mensaje¬†=¬†`${EMAYORDOMO.simboloError}¬†El¬†proceso¬†en¬†2¬∫¬†plano¬†no¬†est√°¬†activado.`;
 ¬†¬†¬†¬†¬†}¬†else¬†{
 ¬†¬†¬†¬†¬†¬† mensaje¬†=¬†`${EMAYORDOMO.simboloError}¬†El¬†proceso¬†en¬†2¬∫¬†plano¬†debe¬†ser¬†desactivado¬†por¬†${activadoPor}.`;
 ¬†¬†¬†¬†¬†}
 ¬†¬†¬†¬† ssUi.alert(
 ¬†¬†¬†¬†¬†¬† `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
 ¬†¬†¬†¬†¬†¬† mensaje,
 ¬†¬†¬†¬†¬†¬† ssUi.ButtonSet.OK);
 ¬†¬†¬†}¬†¬†¬†¬†¬†¬†¬† 
 ¬†}¬†catch¬†(e)¬†{
    // No ha sido posible obtener acceso al bloque de c√≥digo exclusivo
 ¬†¬† ssUi.alert(
 ¬†¬†¬†¬† `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
 ¬†¬†¬†¬† `${EMAYORDOMO.simboloError}¬†En¬†este¬†momento¬†no¬†es¬†posible¬†desactivar¬†el¬†proceso¬†en¬†2¬∫¬†plano,¬†int√©ntalo¬†m√°s¬†tarde.`,
 ¬†¬†¬†¬† ssUi.ButtonSet.OK);
 ¬†}
```

En todos los casos se actualiza el men√∫ del script antes de finalizar y, como siempre, se lanzan alertas para mantener al usuario informado.

```javascript
  //¬†Se¬†ejecuta¬†siempre¬†para¬†sincronizar¬†estado¬†del¬†men√∫¬†cuanto¬†antes¬†cuando¬†hay¬†varias¬†instancias¬†abiertas¬†de¬†la¬†hdc
  construirMenu(PropertiesService.getDocumentProperties().getProperty(EMAYORDOMO.propActivado));

}
```

### gestionarTrigger()

Se trata de una funci√≥n auxiliar a la que llaman tanto `activar()` como `desactivar()`. Es la que se encarga realmente de crear o destruir el _trigger_, devolviendo como resultado un valor que indica si la operaci√≥n ha podido realizarse con √©xito o no.

```javascript
/**
 *¬†Instala¬†o¬†elimina¬†el¬†trigger¬†que¬†se¬†ejecuta¬†cada¬†hora
 *¬†@param¬†{string}¬†orden¬†"ON"¬†|¬†"OFF"
 *¬†@return¬†{string}¬†Mensaje¬†de¬†error¬†/¬†'OK'.
 */
function¬†gestionarTrigger(orden)¬†{

  let¬†estado¬†=¬†'OK';

  switch¬†(orden)¬†{
 ¬†¬†¬†¬† 
 ¬†¬† case¬†'ON':¬† 
 ¬†¬†¬†¬† //¬†Crear¬†trigger
 ¬†¬†¬†¬† try¬†{
 ¬†¬†¬†¬†¬†¬† ScriptApp.newTrigger('procesarEmails')
 ¬†¬†¬†¬†¬†¬†¬†.timeBased()
 ¬†¬†¬†¬†¬†¬†¬†.everyHours(EMAYORDOMO.horasActivador)
 ¬†¬†¬†¬†¬†¬†¬†.create();
 ¬†¬†¬†¬†¬†}¬†catch(e)¬†{
 ¬†¬†¬†¬†¬†¬† estado¬†=¬†e;
 ¬†¬†¬†¬†¬†}
 ¬†¬†¬†¬† break;
 ¬†¬†¬†¬† 
 ¬†¬† case¬†'OFF':
 ¬†¬†¬†¬† //¬†Eliminar¬†trigger(s)
 ¬†¬†¬†¬† try¬†{
 ¬†¬†¬†¬†¬†¬† const¬†triggers¬†=¬†ScriptApp.getProjectTriggers();
 ¬†¬†¬†¬†¬†¬† triggers.filter(t¬†=>¬†t.getEventType()¬†==¬† ScriptApp.EventType.CLOCK).forEach(trigger¬†=>¬†ScriptApp.deleteTrigger(trigger));
 ¬†¬†¬†¬†¬†}¬†catch¬†(e)¬†{
 ¬†¬†¬†¬†¬†¬† estado¬†=¬†e;
 ¬†¬†¬†¬†¬†}
 ¬†¬†¬†¬† 
 ¬†¬†¬†¬† break;
 ¬†}

  return¬†estado;

}
```

Important√≠simo de nuevo el uso de un bloque [`try...catch`](https://developer.mozilla.org/es/docs/Web/JavaScript/Reference/Statements/try...catch) para dar caza a los errores en tiempo de ejecuci√≥n y _fallar graciosamente_ cuando corresponda. Y es que si algo puede ir mal al utilizar los servicios de Apps Script, ten por seguro que en alg√∫n momento ir√° mal. M√°s vale que est√©s preparados para manejar la situaci√≥n.

Para establecer intervalos de ejecuci√≥n con mayor granularidad bastar√≠a sustituir el m√©todo [`everyHours()`](https://developers.google.com/apps-script/reference/script/clock-trigger-builder#everyhoursn) por [`everyMinutes()`](https://developers.google.com/apps-script/reference/script/clock-trigger-builder#everyminutesn).

## C√≥digo.gs

Este es el archivo que contiene el c√≥digo principal de eMayordomo. Contiene varias funciones y un bloque de inicializaci√≥n de constantes utilizado en distintas secciones del script.

```javascript
//¬†Algunas¬†inicializaciones
const¬†EMAYORDOMO¬†=¬†{
  version: 'Versi√≥n: 1.0¬†(junio¬†2021)',
  icono: 'üì≠',
  nombre: 'eMayordomo',
  tablaReglas: {
 ¬†¬† nombre: 'üîÄ¬†Reglas',
 ¬†¬† colInicioRegla: 0,
 ¬†¬† colFinRegla: 2,
 ¬†¬† filInicialDatos: 2
 ¬†},
  tablaLog: {
 ¬†¬† nombre: 'üóíÔ∏è¬†Registro',
 ¬†¬† filInicialDatos: 3
 ¬†},
  simboloOk: 'üÜó',
  simboloError: '‚ö†Ô∏è',
  simboloInfo: '‚ÑπÔ∏è',
  maxEmails: 20,
  propActivado: 'activadoPor',
  horasActivador: 1
};
```

### onOpen()

Esta es la funci√≥n que se ejecuta cada vez que se abre la hoja de c√°lculo. Se limita a leer la propiedad que identifica al usuario que ha realizado la activaci√≥n y pas√°rsela como par√°metro a la funci√≥n `construirMenu()`, que es la que realmente crea el men√∫ del script.

```javascript
/**
 *¬†Construye¬†el¬†men√∫¬†de¬†la¬†aplicaci√≥n¬†al¬†abrir¬†la¬†hdc¬†de¬†acuerdo¬†con¬†el¬†estado¬†de¬†activaci√≥n
 */
function¬†onOpen()¬†{

  construirMenu(PropertiesService.getDocumentProperties().getProperty(EMAYORDOMO.propActivado));

}
```

Como probablemente sepas, [onOpen()](https://developers.google.com/apps-script/guides/triggers?hl=en#onopene) es un [activador simple](https://developers.google.com/apps-script/guides/triggers?hl=en#onopene). Hay que tener cuidado con el c√≥digo que se mete en ellos dado que hay ciertas cosas de las que nos son capaces . Concretamente, no pueden utilizar servicios que requieran de autorizaci√≥n (m√°s sobre esto en el apartado 2.1 de este [art√≠culo](https://comunidad.gedu.es/post/bas-002-exportar-diapositivas-de-una-presentacion-como-png-6072aa8f5c5c167af76f8508)). Afortunadamente, leer las propiedades del documento usando `PropertiesService` no es una de ellas en este caso (:warning: cuidado , otro gallo cantar√≠a si se tratara de un complemento para hojas de c√°lculo, donde existen ciertas [circunstancias](https://developers.google.com/workspace/add-ons/concepts/editor-auth-lifecycle?hl=en#authorization_modes) que complican un poco las cosas).

### construirMenu()

Otra funci√≥n sencillita.

El primer comando del men√∫ del script ser√° uno u otro dependiendo del estado de activaci√≥n de eMayordomo, es decir, de si est√° vigilando o no el buz√≥n de Gmail por medio del consabido activador por tiempo.

```javascript
function¬†construirMenu(activadoPor)¬†{

  //¬†Construye¬†men√∫¬†en¬†funci√≥n¬†del¬†estado¬†del¬†trigger
  const¬†menu¬†=¬†SpreadsheetApp.getUi().createMenu(`${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`);¬† 
  if¬†(!activadoPor)¬†{
 ¬†¬† menu.addItem('Ô∏è‚è∞¬†Procesar¬†etiquetas¬†cada¬†hora',¬†'activar');
 ¬†}¬†else¬†{
 ¬†¬† menu.addItem('‚è∏Ô∏è¬†Dejar¬†de¬†procesar¬†etiquetas¬†cada¬†hora',¬†'desactivar');
 ¬†}

  //¬†Resto¬†del¬†men√∫¬†(no¬†din√°mico)¬† 
  menu.addItem('üîÅ¬†Ejecutar¬†manualmente',¬†'ejecutarManualmente')
  menu.addItem('‚ùì¬†Comprobar¬†estado',¬†'comprobarEstado')
 ¬†¬†¬†.addSeparator()
 ¬†¬†¬†.addItem(`üí°¬†Acerca¬†de¬†${EMAYORDOMO.nombre}`,¬†'acercaDe')
 ¬†¬†¬†.addToUi();

}
```

### acercaDe()

Esta funci√≥n es invocada por el comando `üí°¬†Acerca¬†de eMayordomo` y se utiliza para abrir la ventana de informaci√≥n de eMayordomo, parametrizando su contenido con sendos _scriptlets._ Esto ya lo comentamos en el apartado dedicado a [acercaDe.html](#acercadehtml), as√≠ que nada m√°s que decir aqu√≠.

### ejecutarManualmente()

eMayordomo tambi√©n admite la ejecuci√≥n manual del proceso de atenci√≥n a los mensajes recibidos en el buz√≥n de Gmail. Esto puede resultar de utilidad para procesar correos electr√≥nicos a los que no se ha respondido como consecuencia de alg√∫n error temporal.

Esta funci√≥n puede invocarse con el comando `üîÅ¬†Ejecutar¬†manualmente`.

![](https://user-images.githubusercontent.com/12829262/123556666-c1b21980-d78c-11eb-9a60-05900701e74f.png)

Si un usuario distinto al que ejecuta la funci√≥n ya ha activado el funcionamiento en 2¬∫ plano de eMayordomo la ejecuci√≥n manual queda cancelada. L√≥gico, el buz√≥n de Gmail no ser√° en ese caso el del usuario actual.

```javascript
/**
 *¬†Men√∫¬†>>¬†Ejecutar¬†manualmente¬†la¬†funci√≥n¬†procesarEmails(),
 *¬†Trata¬†de¬†impedir¬†que¬†un¬†usuario¬†distinto¬†al¬†propietario¬†de¬†la¬†hdc¬†realice¬†un¬†proceso¬†manual
 *¬†esto¬†es¬†una¬†medida¬†de¬†seguridad¬†para¬†evitar¬†que¬†eMayordomo¬†act√∫e¬†sobre¬†el¬†buz√≥n¬†de
 *¬†Gmail¬†incorrecto.¬†La¬†comprobaci√≥n¬†no¬†es¬†concluyente¬†cuando¬†la¬†hdc¬†reside¬†en¬†una
 *¬†unidad¬†compartida,¬†en¬†ese¬†caso¬†se¬†solicita¬†confirmaci√≥n¬†al¬†usuario¬†para¬†proceder.
 */
function¬†ejecutarManualmente()¬†{

  const¬†ssUi¬†=¬†SpreadsheetApp.getUi();
  const¬†activadoPor¬†=¬†PropertiesService.getDocumentProperties().getProperty(EMAYORDOMO.propActivado);
  const¬†emailUsuarioActivo¬†=¬†Session.getEffectiveUser().getEmail();
  let¬†ejecutar¬†=¬†true;

  //¬†[1]¬†¬øOtro¬†usuario¬†ha¬†realizado¬†ya¬†la¬†activaci√≥n?
  if¬†(activadoPor¬†&&¬†activadoPor¬†!=¬†emailUsuarioActivo)¬†{
 ¬†¬† ssUi.alert(
 ¬†¬† `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
 ¬†¬† `${EMAYORDOMO.simboloError}¬†Ya¬†hay¬†un¬†proceso¬†en¬†2¬∫¬†plano¬†activado¬†por¬†${activadoPor},¬†no¬†parece
 ¬†¬†¬†buena¬†idea¬†que¬†un¬†usuario¬†distinto¬†(¬°t√∫!)¬†realice¬†un¬†procesado¬†manual.`,
 ¬†¬† ssUi.ButtonSet.OK);
```

En caso contrario, se pasa a determinar qui√©n es el propietario de ¬†la hoja de c√°lculo, del mismo modo que en la funci√≥n `activar()`.

```javascript
 ¬†}¬†else¬†{
 ¬†¬† //¬†No¬†hay¬†proceso¬†en¬†2¬∫¬†plano¬†activo,¬†veamos¬†qui√©n¬†es¬†el¬†propietario¬†de¬†la¬†hdc¬†¬°getOwner()¬†devuelve¬†null¬†si¬†hdc¬†est√°¬†en¬†unidad¬†compartida!
 ¬†¬† let¬†emailPropietario;
 ¬†¬† const¬†propietario¬†=¬†SpreadsheetApp.getActiveSpreadsheet().getOwner();
 ¬†¬† if¬†(propietario)¬†{
 ¬†¬†¬†¬† emailPropietario¬†=¬†propietario.getEmail();
 ¬†¬†¬†}¬†else¬†{
 ¬†¬†¬†¬† emailPropietario¬†=¬†null;
 ¬†¬†¬†}
```

Lo que sigue es muy similar. Si la hoja de c√°lculo est√° en una unidad compartida se pide confirmaci√≥n al usuario.

```javascript
 ¬†¬† //¬†[2]¬†Si¬†la¬†hdc¬†est√°¬†en¬†unidad¬†compartida¬†y¬†el¬†proceso¬†en¬†2¬∫¬†plano¬†no¬†ha¬†sido¬†activado¬†por¬†el¬†usuario¬†actual¬†solicitar¬†confirmaci√≥n¬†para¬†proseguir
 ¬†¬† if¬†(!emailPropietario¬†&&¬†activadoPor¬†!=¬†emailUsuarioActivo)¬†{
 ¬†¬†¬†¬† ejecutar¬†=¬†ssUi.alert(
 ¬†¬†¬†¬†¬†¬† `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
 ¬†¬†¬†¬†¬†¬† `Solo¬†el¬†propietario¬†del¬†buz√≥n¬†de¬†Gmail¬†en¬†el¬†que¬†se¬†han¬†definido¬†las¬†reglas¬†de
 ¬†¬†¬†¬†¬†¬†¬†filtrado,¬†etiquetas¬†y¬†borradores¬†debe¬†realizar¬†un¬†procesado¬†manual.
 ¬†¬†¬†¬†¬†¬† 
 ¬†¬†¬†¬†¬†¬†¬†¬øSeguro¬†que¬†deseas¬†continuar?`,
 ¬†¬†¬†¬†¬†¬† ssUi.ButtonSet.OK_CANCEL)¬†==¬†ssUi.Button.OK;
```

Si no lo est√°, se verifica si el usuario activo no es el propietario de la hoja de c√°lculo, en ese caso se cancela tambi√©n la ejecuci√≥n manual.

```javascript
 ¬†¬†}¬†else¬†if¬†(emailPropietario¬†&&¬†emailPropietario¬†!=¬†emailUsuarioActivo)¬†{
 ¬†¬†  //¬†[3]¬†Cancelar¬†ejecuci√≥n¬†si¬†se¬†puede¬†determinar¬†que¬†el¬†usuario¬†actual¬†no¬†es¬†el¬†propietario¬†de¬†la¬†hdc
 ¬†¬†¬†¬†ssUi.alert(
 ¬†¬†¬†¬†`${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
 ¬†¬†¬†¬†`${EMAYORDOMO.simboloError}¬†Solo¬†${emailPropietario}¬†debe¬†realizar¬†un¬†procesado¬†manual.`,
 ¬†¬†¬†¬†ssUi.ButtonSet.OK);
 ¬†¬†¬†¬†ejecutar¬†=¬†false;
 ¬†¬†}
```

Por √∫ltimo se llama, en su caso, a la funci√≥n `procesarEmails()`.

```javascript
    //¬†Seguir¬†con¬†ejecuci√≥n¬†manual¬†a¬†menos¬†que¬†se¬†haya¬†cancelado¬†en¬†[2]¬†o¬†[3]
¬†   if¬†(ejecutar)¬†{
¬†¬†¬†   //¬†Ejecutar¬†proceso¬†sobre¬†el¬†buz√≥n¬†de¬†Gmail
¬†¬†¬†   procesarEmails();
¬†¬†¬†   ssUi.alert(
¬†¬†¬†¬†¬†   `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
¬†¬†¬†¬†¬†   `Ejecuci√≥n¬†manual¬†terminada.¬†Revisa¬†la¬†hoja¬†${EMAYORDOMO.tablaLog.nombre}.`,
¬†¬†¬†¬†¬†   ssUi.ButtonSet.OK);
¬†¬†  }¬†else¬†{
¬†¬†¬†   //¬†Activaci√≥n¬†cancelada
¬†¬†¬†   ssUi.alert(
¬†¬†¬†¬†¬†   `${EMAYORDOMO.icono}¬†${EMAYORDOMO.nombre}`,
¬†¬†¬†¬†¬†   `Ejecuci√≥n¬†manual¬†cancelada.`,
¬†¬†¬†¬†¬†   ssUi.ButtonSet.OK);
¬†¬†  }
  }

}
```

### procesarEmails()

Esta funci√≥n constituye el bloque principal de eMayordomo. Contiene el c√≥digo que revisa los mensajes a procesar en el buz√≥n de entrada y env√≠a las respuestas autom√°ticas de acuerdo con las reglas definidas por el usuario.

La cosa comienza con la lectura de una serie de par√°metros de funcionamiento desde las celdas de la hoja üîÄ **Reglas**. La variable `selloTiempo` se utilizar√° para datar en la hoja del registro de operaciones cada la ejecuci√≥n de esta funci√≥n.

```javascript
/**
 *¬†Revisa¬†el¬†buz√≥n¬†de¬†Gmail¬†del¬†usuario¬†que¬†lo¬†ejecuta¬†y¬†responde¬†a¬†los¬†mensajes
 *¬†con¬†respuestas¬†preparadas¬†de¬†acuerdo¬†a¬†las¬†reglas¬†de¬†procesamiento¬†definidas
 *¬†en¬†el¬†hojaEMAYORDOMO.tablaReglas.nombre.
 *¬†Los¬†mensajes¬†a¬†los¬†que¬†se¬†ha¬†respondido¬†quedan¬†marcados¬†como¬†le√≠dos¬†y¬†no¬†destacados.
 */
function¬†procesarEmails()¬†{

  //¬†Sello¬†de¬†tiempo¬†de¬†este¬†lote
  const¬†selloTiempo¬†=¬†new¬†Date();

  //¬†Registro¬†de¬†operaciones
  const¬†operaciones¬†=¬†[];

  //¬†Leer¬†reglas¬†de¬†procesamiento¬†de¬†mensajes¬†recibidos
  const¬†reglas¬†=¬†SpreadsheetApp.getActive().getSheetByName(EMAYORDOMO.tablaReglas.nombre).getDataRange().getValues();
  const¬†[encabezados,¬†...tabla]¬†=¬†reglas;

  //¬†Identificar¬†columnas¬†en¬†la¬†tabla¬†de¬†configuraci√≥n¬†/¬†resultados
  //¬†const¬†colProcesar¬†=¬†¬†encabezados.indexOf('‚òëÔ∏è');
  const¬†colEtiqueta¬†=¬†encabezados.indexOf('Etiqueta¬†a¬†procesar');
  const¬†colPlantilla¬†=¬†encabezados.indexOf('Plantilla¬†email');
  const¬†colRegExEmail¬†=¬†encabezados.indexOf('RegEx¬†extracci√≥n¬†email');
```

A continuaci√≥n se enumeran las etiquetas que intervienen en alguna regla (`etiquetasReglas`), las existentes en el buz√≥n de Gmail (`etiquetasUsuario`) y los mensajes en borrador (`borradores`). Estos √∫ltimos se guardan de cierta manera con el objetivo de facilitar las acciones posteriores:

*   Id del borrador.
*   Objeto [`GmailMessage`](https://developers.google.com/apps-script/reference/gmail/gmail-message) asociado al borrador.
*   Prefijo del asunto del mensaje, de la forma `[identificador]`. Ejemplo: Si el asunto es "_\[GEN\] Informaci√≥n general_", el prefijo almacenado ser√° "_\[GEN\]_".
*   Asunto del mensaje, sin su \[prefijo\] ni el espacio posterior que lo separa del asunto real. Siguiendo con el ejemplo anterior, aqu√≠ se guardar√° "_Informaci√≥n general_".

Para extraer prefijo y asunto se emplea un [`match()`](https://developer.mozilla.org/es/docs/Web/JavaScript/Reference/Global_Objects/String/match) con sendos grupos de captura.

```javascript
  // Obtener etiquetas de las reglas a procesar: todos los campos requeridos de la regla deben ser VERDADERO (o truthy)
  // En la hdc se impide que varias reglas se apliquen sobre una misma etiqueta por medio de validaci√≥n de datos
  const etiquetasReglas = tabla.filter(regla =>
    regla.slice(EMAYORDOMO.tablaReglas.colInicioRegla, EMAYORDOMO.tablaReglas.colFinRegla + 1).every(campo => campo))
    .map(regla => regla[colEtiqueta]);

  // Obtener etiquetas existentes en el buz√≥n, la usaremos m√°s adelante para comprobar que las reglas son v√°lidas
  const etiquetasUsuario = GmailApp.getUserLabels().map(etiqueta => etiqueta.getName());

  // Obtener mensajes en borrador {idBorrador, mensaje, [prefijo asunto, asunto sin prefijo]}
  const borradores = GmailApp.getDrafts().map(borrador => 
    ({
      id: borrador.getId(),
      mensaje: borrador.getMessage(),
      // Obtener prefijo (asuntoRegEx[1]) y asunto (asuntoRegEx[2])
      asuntoRegEx: borrador.getMessage().getSubject().match(/^(\[.+\]) (.+)$/)
    })
  );
```

El nombre que aparecer√° como remitente en las respuestas enviadas se intenta tomar del propio nombre asignado a la hoja de c√°lculo. Se emplea para ello una expresi√≥n regular que trata de extraer una secuencia de texto, entre par√©ntesis y precedida de un espacio, de la parte final del nombre del archivo. Lo s√©, esto es una rareza, pero en alg√∫n momento me debi√≥ parecer una buena idea.

```javascript
  //¬†Se¬†intenta¬†extraer¬†el¬†nombre¬†del¬†remitente¬†de¬†las¬†respuestas¬†a¬†partir¬†del¬†nombre¬†de¬†la¬†hoja¬†de¬†c√°lculo¬†>>¬†"texto¬†(remitente)"
  let¬†remitente¬†=¬†SpreadsheetApp.getActiveSpreadsheet().getName().match(/^.+\((.+)\)$/);
  if¬†(remitente)¬†{
 ¬†¬† remitente¬†=¬†remitente[1];
 ¬†}¬†else¬†{
    // ...en caso contrario, nombre usuario (valor por defecto al enviar emails con GmailApp/MailApp si no se especifica 'name')
 ¬†¬† remitente¬†=¬†Session.getEffectiveUser().getEmail().match(/^(.+)@.+$/)[1];
 ¬†}
```

El bucle principal de la funci√≥n recorre totas las etiquetas (reglas de auto respuesta) que se han establecido en la hoja de c√°lculo por medio de un `forEach()`.

Las primeras comprobaciones se aseguran de que la regla asociada a la etiqueta sea v√°lida y de que exista un borrador en el buz√≥n con un asunto cuyo prefijo sea coincidente con el especificado en la regla. De no ser as√≠, se registra la naturaleza del error en el vector `operaciones` y se pasa a analizar la siguiente etiqueta.

```javascript
  // Procesar cada regla / etiqueta
  etiquetasReglas.forEach(etiqueta => {

    // ¬øLa etiqueta que vamos a procesar existe realmente en el buz√≥n?

    if (!etiquetasUsuario.includes(etiqueta)) {
      console.error(`La etiqueta "${etiqueta}" no existe.`);
      operaciones.push(
        {
          estado: EMAYORDOMO.simboloError,
          inicio: selloTiempo,
          tiempo: new Date(),
          etiqueta: etiqueta,
          email: '',
          plantilla: '',
          mensaje: `Etiqueta "${etiqueta}" no existe en el buz√≥n`
        });
    } else {

      // La etiqueta s√≠ existe, seguimos...

      const fila = tabla.find(regla => regla[colEtiqueta] == etiqueta);
      const plantilla = fila[colPlantilla];
      const regExEmail = fila[colRegExEmail]; // Opcional

      // ¬øLa plantilla (borrador) a utilizar existe? (¬°cuidado con los duplicados!)

      const borrador = borradores.find(borrador => borrador.asuntoRegEx ? borrador.asuntoRegEx[1] == plantilla : null);
      if (!borrador) {
        console.error(`El borrador con prefijo "${plantilla} " no existe.`);
        operaciones.push(
          {
            estado: EMAYORDOMO.simboloError,
            inicio: selloTiempo,
            tiempo: new Date(),
            etiqueta: etiqueta,
            email: '',
            plantilla: plantilla,
            mensaje: `Borrador no encontrado`
          });
```

Ahora se obtienen los hilos de mensajes en el buz√≥n que est√°n marcados con la etiqueta. En ellos se encontrar√°n los mensajes a los que se debe responder.

El m√©todo usado, [`GmailLabel.getThreads()`](https://developers.google.com/apps-script/reference/gmail/gmail-label#getThreads()), no dispone de un mecanismo de tipo `nextPageToken`, similar al de otros m√©todos que devuelven resultados paginados como por ejemplo [`Courses.list`](https://developers.google.com/classroom/reference/rest/v1/courses/list) en el servicio avanzado / API de Classroom. No queda m√°s remedio que invocarlo de manera iterativa hasta que el n√∫mero de resultados obtenido sea inferior al valor m√°ximo solicitado, parametrizado con `EMAYORDOMO.maxEmails`. ¬ø[Inconsistencias](https://twitter.com/pfelipm/status/1383837878686412809)? Bueno, alguna que otra, qu√© le vamos a hacer.

```javascript
 ¬†¬†¬†¬†¬†}¬†else¬†{¬†¬†¬† 

 ¬†¬†¬†¬†¬†¬† //¬†Etiqueta,¬†borrador¬†y¬†regla¬†OK,¬†intentemos¬†responder¬†a¬†los¬†mensajes 

 ¬†¬†¬†¬†¬†¬† //¬†Extraer¬†hilos¬†con¬†la¬†etiqueta¬†actual
 ¬†¬†¬†¬†¬†¬† let¬†hilosEtiquetados¬†=¬†[];
 ¬†¬†¬†¬†¬†¬† let¬†nHilo¬†=¬†0;
 ¬†¬†¬†¬†¬†¬† let¬†nHilos;
 ¬†¬†¬†¬†¬†¬† do¬†{
 ¬†¬†¬†¬†¬†¬†¬†¬† //¬†Devuelve¬†0¬†si¬†no¬†hay¬†mensajes
 ¬†¬†¬†¬†¬†¬†¬†¬† const¬†paginaHilos¬†=¬†GmailApp.getUserLabelByName(etiqueta).getThreads(nHilo,¬†EMAYORDOMO.maxEmails);
 ¬†¬†¬†¬†¬†¬†¬†¬† nHilos¬†=¬†paginaHilos.length;
 ¬†¬†¬†¬†¬†¬†¬†¬† if¬†(nHilos)¬†{
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† hilosEtiquetados¬†=¬†[...hilosEtiquetados,¬†...paginaHilos];
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† nHilo¬†+=¬†nHilos;
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†}
 ¬†¬†¬†¬†¬†¬† //¬†Si¬†se¬†ha¬†devuelto¬†el¬†n¬∫¬†m√°ximo¬†de¬†mensajes¬†solicitados¬†haremos¬†una¬†nueva¬†iteraci√≥n,¬†tal¬†vez¬†haya¬†m√°s
 ¬†¬†¬†¬†¬†¬†¬†}¬†while¬†(nHilos¬†==¬†EMAYORDOMO.maxEmails);
```

:warning: Ojito con [esto](https://twitter.com/pfelipm/status/1399052196025712642): Lo habitual es que los buzones de Gmail tengan activada la [vista de conversaci√≥n](https://support.google.com/mail/answer/5900), que agrupa los mensajes que identifica como relacionados. Aunque la interfaz de Gmail solo nos permita asignar etiquetas de usuario a hilos completos, realmente estas etiquetas s√≠ pueden establecerse sobre mensajes individuales. El caso es que si dentro de un hilo hay mensajes con distintas etiquetas, este hilo ser√° devuelto como resultado al invocar a `getThreads()` con cualquiera de ellas.

¬øSoluciones? Pues se me ocurren dos, la que he usado en el script y la correcta :wink: . M√°s adelante hablaremos de ambas.

El siguiente paso es recorrer todos los hilos en los que aparece la etiqueta que estamos procesando.

Como sabes, eMayordomo espera que los filtros de correo que etiquetan los mensajes recibidos queden marcados como destacados :star:. Por esa raz√≥n, lo primero que haremos en esta fase es descartar los hilos que no contengan mensajes destacados, a esos ya habremos respondido.¬†

```javascript
 ¬†¬†¬†¬†¬†  //¬†Recorramos¬†ahora¬†los¬†mensajes¬†de¬†todos¬†los¬†hilos
 ¬†¬†¬†¬†¬†¬† hilosEtiquetados.forEach(hilo¬†=>¬†{
 ¬†¬†¬†¬†¬†¬†¬†¬† 
 ¬†¬†¬†¬†¬†¬†¬†¬† //¬†¬øHay¬†mensajes¬†con¬†estrella¬†(no¬†procesados)¬†en¬†el¬†hilo?
 ¬†¬†¬†¬†¬†¬†¬†¬† //¬†Alternativa¬†>>¬†Usar¬†fecha¬†de¬†√∫ltima¬†ejecuci√≥n¬†vs¬†fecha¬†mensaje¬†(¬øcondiciones¬†de¬†carrera?)
 ¬†¬†¬†¬†¬†¬†¬†¬† if¬†(hilo.hasStarredMessages())¬†{
```

Seguidamente se revisan todos y cada uno de los mensajes del hilo, pero solo se tratar√° de responder a aquellos a los que realmente se les haya aplicado la etiqueta que se esta procesando en esta iteraci√≥n. Esta comprobaci√≥n adicional, que se realiza gracias a la funci√≥n auxiliar `etiquetasMensaje()`, constituye la soluci√≥n funcional (que no √≥ptima), a la ambig√ºedad que nos est√° introduciendo el m√©todo `getThreads()` como consecuencia del problema descrito anteriormente.

```javascript
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† hilo.getMessages().forEach(mensaje¬†=>¬†{
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† 
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† //¬†¬øMensaje¬†a√∫n¬†no¬†procesado¬†*y*¬†etiquetado¬†con¬†etiqueta¬†que¬†estamos¬†procesando?
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† //¬†Si¬†est√°¬†activada¬†la¬†vista¬†de¬†conversaci√≥n¬†en¬†Gmail¬†es¬†posible¬†que¬†el¬†hilo
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† //¬†contenga¬†mensajes¬†con¬†distintas¬†etiquetas.¬†Al¬†usar¬†GmailLabel.getThreads()
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† //¬†se¬†devolver√°n¬†todos¬†siempre,¬†por¬†lo¬†que¬†es¬†necesaria¬†esta¬†comprobaci√≥n¬†adicional,
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† //¬†que¬†utiliza¬†el¬†servicio¬†avanzado¬†de¬†Gmail¬†para¬†enumerar¬†las¬†etiquetas¬†propias
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† //¬†de¬†un¬†mensaje¬†dado.
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if¬†(mensaje.isStarred()¬†&&¬†etiquetasMensaje(mensaje,¬†etiqueta))¬†{
```

Si todas estas condiciones son satisfechas se pasa a determinar la direcci√≥n del correo electr√≥nico a la que se debe responder. La estrategia es la siguiente:

1.  Si la regla de auto respuesta definida en la hoja de c√°lculo dispone de una expresi√≥n regular para extraer el email del cuerpo del mensaje (columna `D` en la tabla) se aplica sobre √©l.
2.  Si la cadena de texto devuelta por la aplicaci√≥n de la expresi√≥n regular _parece_ una direcci√≥n de correo electr√≥nico, se utiliza como email al que responder.
3.  Si \[1\] o \[2\] no se cumplen, se utiliza el contenido del campo `Reply-To` del mensaje recibido.
4.  En √∫ltima instancia se utiliza el campo `From:` del mensaje recibido.

```javascript
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† const¬†body¬†=¬†mensaje.getPlainBody();
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† let¬†destinatario;

 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† //¬†Destinatario: 1¬∫¬†RegEx,¬†2¬∫¬†Responder¬†a,¬†3¬∫¬†Remitente
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if¬†(regExEmail)¬†destinatario¬†=¬†body.match(new¬†RegExp(regExEmail))[1];
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† 
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† //¬†¬øEl¬†email¬†extra√≠do¬†tiene¬†pinta¬†de¬†email?
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† const¬†emailTest¬†=¬†/^\S+@\S+\.[a-z]{2,}$/;

 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† //¬†Si¬†es¬†que¬†no,¬†o¬†no¬†se¬†ha¬†usando¬†una¬†RegEx,¬†utilizar¬†responder-a¬†(puede¬†no¬†haberlo)¬†o¬†remitente¬†(en¬†ese¬†orden)
 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if¬†(!regExEmail¬†||¬†!(emailTest.test(destinatario)))¬†destinatario¬†=¬†mensaje.getReplyTo()¬†?¬†mensaje.getReplyTo() :¬†mensaje.getFrom();
```

Finalmente, solo resta duplicar el borrador (si lo envi√°ramos tal cual nos quedar√≠amos sin √©l). Para ello se llama a la funci√≥n `extraerElementos()`, que devuelve un objeto que contiene:

*   El cuerpo del mensaje, en formato HTML.
*   Sus archivos adjuntos.
*   Las im√°genes incrustadas.

De ese modo resulta posible utilizar a continuaci√≥n el m√©todo [`MailApp.sendEmail()`](https://developers.google.com/apps-script/reference/mail/mail-app#sendEmail(String,String,String,Object)), pas√°ndole en su objeto de [par√°metros avanzados](https://developers.google.com/apps-script/reference/mail/mail-app#advanced-parameters_1) los elementos que se acaban de duplicar a partir del borrador. ¬øPor qu√© `MailApp` en lugar de `GmailApp`? Pues porque [la segunda no admite emojis](https://twitter.com/pfelipm/status/1395116007623122947).

```javascript
                // Extraer el cuerpo HTML, im√°genes en l√≠nea y adjuntos del borrador correspondiente
                const elementosMensaje = extraerElementos(borrador.mensaje);

                // Enviar mensaje y eliminar estrella si todo ha ido bien

                try {
                  // Usaremos MailApp dado que GmailApp no preserva emojis en asunto ni cuerpo:
                  // https://stackoverflow.com/questions/50686254/how-to-insert-an-emoji-into-an-email-sent-with-gmailapp/50690214
                  MailApp.sendEmail(destinatario, borrador.asuntoRegEx[2],
                    'Debes usar un cliente de correo compatible con HTML para visualizar este mensaje.',
                    {
                      htmlBody: elementosMensaje.htmlBody,
                      attachments: elementosMensaje.attachments,
                      inlineImages: elementosMensaje.inlineImages,
                      name: remitente
                    });

                  // El estado "destacado" no se refresca visualmente (s√≠ internamente) si ha sido establecido *manualmente* >>  https://issuetracker.google.com/issues/77320923
                  mensaje.unstar().markRead().refresh();

                  operaciones.push(
                    {
                      estado: EMAYORDOMO.simboloOk,
                      inicio: selloTiempo,
                      tiempo: new Date(),
                      etiqueta: etiqueta,
                      email: destinatario,
                      plantilla: plantilla,
                      mensaje: `Autorespuesta enviada`
                    });

                } catch(e) {
                  console.error(`Error al enviar respuesta ${plantilla} a ${remitente}.`);
                  operaciones.push(
                    {
                      estado: EMAYORDOMO.simboloError,
                      inicio: selloTiempo,
                      tiempo: new Date(),
                      etiqueta: etiqueta,
                      email: destinatario,
                      plantilla: plantilla,
                      mensaje: `Error indeterminado al enviar email`
                    });
                }
              }

              // Refresca hilo para que .hasStarredMessages() devuelva el valor correcto inmediatamente >> https://stackoverflow.com/a/65515913
              hilo.refresh();  
            }); // De env√≠o de respuesta  

            hilo.moveToArchive().refresh();

          } // De procesamiento de mensajes de cada hilo
        }); // De procesamiento de hilos
      } // De comprobaci√≥n de existencia de plantilla
    } // De existencia de etiqueta a procesar
  }); // De proceso de la regla de cada etiqueta
```

Al mensaje atendido se marca como le√≠do y se le retira la marca de destacado, de ese modo ya no volver√° a procesarse en una pr√≥xima ejecuci√≥n de la funci√≥n y como siempre, se registra el resultado de la operaci√≥n en el vector `operaciones`. Adem√°s, tras procesar todos los mensajes contenidos en un hilo dado este se archiva para quitarlo de enmedio.

Finalmente, el registro completo de operaciones se traslada a la pesta√±a üóíÔ∏è **Registro** de la hoja de c√°lculo de una vez, reduciendo de este modo las operaciones de escritura sobre ella, que son, temporalmente costosas, al m√°ximo.

```
 //¬†Escribe¬†eventos¬†en¬†log¬†(hdc)¬†solo¬†al¬†finalizar¬†completamentente¬†la¬†ejecuci√≥n
  if¬†(operaciones.length¬†==¬†0)¬†{
 ¬†¬† operaciones.push(
 ¬†¬†¬†¬†¬†{
 ¬†¬†¬†¬†¬†¬† estado: EMAYORDOMO.simboloInfo,
 ¬†¬†¬†¬†¬†¬† inicio: selloTiempo,
 ¬†¬†¬†¬†¬†¬† tiempo: new¬†Date(),
 ¬†¬†¬†¬†¬†¬† etiqueta: '',
 ¬†¬†¬†¬†¬†¬† email: '',
 ¬†¬†¬†¬†¬†¬† plantilla: '',
 ¬†¬†¬†¬†¬†¬† mensaje: 'Sin¬†actividad'
 ¬†¬†¬†¬†¬†});
 ¬†}
  actualizarLog(operaciones);

}
```

### etiquetasMensaje()

Es una sencilla funci√≥n auxiliar que devuelve `TRUE` si el mensaje que se pasa como par√°metro est√° marcado con la etiqueta de Gmail facilitada.

```javascript
/**
 *¬†Devuelve¬†TRUE¬†si¬†el¬†mensaje¬†est√°¬†etiquetado¬†con¬†la¬†etiqueta
 *¬†que¬†se¬†pasa¬†como¬†par√°metro
 *¬†@param¬†{GmailMessage}¬†msg
 *¬†@param¬†{string}¬†etiqueta
 *¬†@returns¬†{Boolean}
 */
function¬†etiquetaMensaje(msg,¬†etiqueta)¬†{

  const¬†id¬†=¬†msg.getId();
  const¬†idEtiqueta¬†=¬†Gmail.Users.Labels.list('me').labels.find(e¬†=>¬†e.name¬†==¬†etiqueta).id;
  etiquetas¬†=¬†Gmail.Users.Messages.get('me',¬†id).labelIds;

  if¬†(etiquetas.map)¬†{
 ¬†¬† return¬†etiquetas.includes(idEtiqueta);
 ¬†}
  else¬†{
 ¬†¬† return¬†false;
 ¬†}

}
```

### duplicarBorradorAPI() y extraerElementos()

El nudo gordiano del desarrollo de eMayordomo ha sido sin duda c√≥mo confeccionar y enviar correos electr√≥nicos a partir de borradores.

Mi estrategia inicial se bas√≥ en \[1\] duplicar un borrador dado para a continuaci√≥n \[2\] modificar el asunto (recuerda que necesitamos eliminar el prefijo que se usa como elemento selector en las reglas de respuesta autom√°tica) para finalmente enviar la copia al destinatario apropiado.

Lo primero se puede resolver con estas l√≠neas de c√≥digo, correspondientes a ¬†`duplicarBorradorAPI()`, que usan de manera directa la [API de Gmail](https://developers.google.com/gmail/api), concretamente su m√©todo [users.drafts.create](https://developers.google.com/gmail/api/reference/rest/v1/users.drafts/create). El truco est√° en emplear el URI de subida de archivos para conseguir una r√©plica perfecta de im√°genes incrustadas y adjuntos, a partir del contenido crudo del borrador original, le√≠do con [`GmailMessage.getRawContent()`](https://developers.google.com/apps-script/reference/gmail/gmail-message#getRawContent()).

```javascript
/**
 *¬†///¬†NO¬†UTILIZADO¬†///
 *¬†Crea¬†un¬†duplicado¬†del¬†borrador¬†cuyo¬†id¬†se¬†pasa¬†como¬†par√°metro,
 *¬†incluyendo¬†cuerpo¬†html,¬†im√°genes¬†en¬†l√≠nea¬†y¬†adjuntos.
 * 
 *¬†Usa¬†la¬†API¬†avanzada¬†de¬†Gmail¬†v√≠a¬†REST
 *¬†Problema: posteriormente¬†no¬†consigo¬†modificar¬†las¬†cabeceras
 *¬†para¬†establecer¬†ASUNTO¬†o¬†DESTINATARIO¬†¬øv√≠a¬†muerta?
 * 
 *¬†@param¬†¬†¬†{string}¬†¬†¬†¬†¬†¬†¬†¬†idBorrador
 *¬†@returns¬†{null¬†|¬†Object}¬†Nuevo¬†borrador¬†o¬†null,¬†si¬†no¬†ha¬†sido¬†posible¬†crearlo
 *¬†¬†¬†{
 *¬†¬†¬†¬†¬†¬†"id": string,
 *¬†¬†¬†¬†¬†¬†"message": {
 *¬†¬†¬†¬†¬†¬†¬†¬†"id": ID_MENSAJE
 *¬†¬†¬†¬†¬†¬†¬†¬†"threadId": ID_HILO
 *¬†¬†¬†¬†¬†¬†¬†¬†"labelIds": ['ETIQUETA']
 *¬†¬†¬†¬†¬†¬†¬†}
 *¬†¬†¬†}
 */
function¬†duplicarBorradorAPI(idBorrador)¬†{

  let¬†nuevoBorrador;
  try¬†{

 ¬†¬†¬†¬† const¬†borrador¬†=¬†GmailApp.getMessageById(idBorrador);
 ¬†¬†¬†¬† const¬†endPoint¬†=¬†'https://www.googleapis.com/upload/gmail/v1/users/me/drafts?uploadType=media';
 ¬†¬†¬†¬† const¬†parametros¬†=¬†{
 ¬†¬†¬†¬†¬†¬† method: 'POST',
 ¬†¬†¬†¬†¬†¬† contentType: 'message/rfc822',
 ¬†¬†¬†¬†¬†¬† muteHttpExceptions: true,
 ¬†¬†¬†¬†¬†¬† headers: {'Authorization': `Bearer¬†${ScriptApp.getOAuthToken()}`},
 ¬†¬†¬†¬†¬†¬† payload: borrador.getRawContent()
 ¬†¬†¬†¬†¬†};
 ¬†¬†¬†¬† nuevoBorrador¬†=¬†UrlFetchApp.fetch(endPoint,¬†parametros);
 ¬†¬† 
 ¬†¬†¬†}¬†catch(e)¬†{
 ¬†¬†¬†¬† return¬†null;
 ¬†¬†¬†}

  return¬†nuevoBorrador.getResponseCode()¬†==¬†200¬†?¬†JSON.parse(nuevoBorrador.getContentText()) :¬†null;

}
```

Pero lo segundo ya no estuvoo tan claro. [No hall√© el modo](https://twitter.com/pfelipm/status/1394808527156400128) de actualizar satisfactoriamente las cabeceras de la copia del borrador sin incluir en el cuerpo de la petici√≥n dirigida al m√©todo [users.drafts.update](https://developers.google.com/gmail/api/reference/rest/v1/users.drafts/update) la secuencia modificada de bytes del email en crudo, representada como una cadena de texto en formato [RFC 2822](https://datatracker.ietf.org/doc/html/rfc2822) y con una codificaci√≥n [Base64 apta para URL](https://base64.guru/standards/base64url). Un foll√≥n en el que no me apetec√≠a nada meterme.

![](https://user-images.githubusercontent.com/12829262/123703247-6d7a6880-d864-11eb-8d16-5120bf864d9a.png)

Supongo que podr√≠a haber optado por eliminar el \[prefijo\] del asunto del borrador, hacer seguidamente una copia del mensaje y finalmente restaurarlo. Pero me pareci√≥ poco elegante, as√≠ que busqu√© otro modo de conseguirlo.

Afortunadamente (casi) todos los caminos parecen estar andados. Martin Hakwsey [ya hab√≠a propuesto](https://twitter.com/pfelipm/status/1384513431005548551) recientemente una estrategia alternativa para resolver este problema, un tanto m√°s complicada pero que resuelve el problema estupendamente (_thanks for pointing me in the right direction, Martin_). ¬†

As√≠ que con su permiso, me la traje a la funci√≥n `extraerElementos()`.

```javascript
/**
 *¬†Crea¬†un¬†duplicado¬†del¬†cuerpo¬†html,¬†im√°genes¬†en¬†l√≠nea¬†y¬†adjuntos¬†del¬†mensaje
 *¬†cuyo¬†id¬†se¬†pasa¬†como¬†par√°metro.
 * 
 *¬†Usa¬†el¬†servicio¬†est√°ndar¬†de¬†Gmail¬†para¬†reconstruir¬†en¬†nuevo¬†mensaje
 *¬†el¬†contenido¬†del¬†original,¬†incluyendo¬†im√°genes¬†en¬†l√≠nea¬†(reemparejando¬†CIDs)
 *¬†y¬†archivos¬†adjuntos.
 *¬† 
 *¬†@param¬†¬†¬†{GmailMessage}¬†¬†msg
 *¬†@returns¬†{Object}¬†¬†¬†¬†¬†¬†¬†¬†{htmlBody,¬†{attachments},¬†{inLineImages}},¬†si¬†no¬†ha¬†sido¬†posible¬†crearlo
 * 
 *¬†Tomado¬†de:
 *¬†https://hawksey.info/blog/2021/02/everything-you-ever-wanted-to-know-about-gmail-draft-inline-images-and-google-apps-script-but-were-afraid-to-ask/
 */
function¬†extraerElementos(msg)¬†{

  const¬†allInlineImages¬†=¬†msg.getAttachments({includeInlineImages: true,¬†includeAttachments: false});
  const¬†attachments¬†=¬†msg.getAttachments({includeInlineImages: false});
  const¬†htmlBody¬†=¬†msg.getBody(); 

  //¬†Create¬†an¬†inline¬†image¬†object¬†with¬†the¬†image¬†name¬†as¬†key 
  //¬†(can't¬†rely¬†on¬†image¬†index¬†as¬†array¬†built¬†based¬†on¬†insert¬†order)
  const¬†img_obj¬†=¬†allInlineImages.reduce((obj,¬†i)¬†=>¬†(obj[i.getName()]¬†=¬†i,¬†obj)¬†,{});

  //¬†Regex¬†to¬†search¬†for¬†all¬†img¬†string¬†positions¬†with¬†cid¬†and¬†alt
  const¬†imgexp¬†=¬†RegExp('<img.*?src="cid:(.*?)".*?alt="(.*?)"[^\>]+>',¬†'g');
  const¬†matches¬†=¬†[...htmlBody.matchAll(imgexp)];

  //¬†Initiate¬†the¬†allInlineImages¬†object
  const¬†inlineImagesObj¬†=¬†{};
  //¬†built¬†an¬†inlineImagesObj¬†from¬†inline¬†image¬†matches
  //¬†match[1]¬†=¬†cid,¬†match[2]¬†=¬†alt
  matches.forEach(match¬†=>¬†inlineImagesObj[match[1]]¬†=¬†img_obj[match[2]]);

  return¬†{
 ¬†¬† htmlBody: htmlBody,
 ¬†¬† attachments: attachments,
 ¬†¬† inlineImages: inlineImagesObj
 ¬†};

}
```

Su funcionamiento est√° perfectamente descrito [aqu√≠](https://hawksey.info/blog/2021/02/everything-you-ever-wanted-to-know-about-gmail-draft-inline-images-and-google-apps-script-but-were-afraid-to-ask/), as√≠ que no a√±adir√© nada m√°s.

### actualizarLog()

Esta funci√≥n auxiliar es llamada desde `procesarEmails()` para escribir los eventos registrados durante su ejecuci√≥n en la tabla de üóíÔ∏è **Registro** de la hoja de c√°lculo.

```javascript
/**
 *¬†Anota¬†en¬†la¬†tabla¬†de¬†registro¬†el¬†resultado¬†de¬†una¬†o¬†varias¬†operaciones
 *¬†en¬†orden¬†inverso¬†(primero¬†el¬†m√°s¬†reciente)
 *¬†@params¬†{Object[]}¬†registros¬†Vector¬†de¬†elementos¬†a¬†registrar:
 *¬†¬†{¬†estado: >>¬†s√≠mbolo¬†de¬†error
 *¬†¬†¬†¬†inicio: >>¬†selleo¬†de¬†tiempo¬†del¬†lote¬†de¬†ejecuci√≥n
 *¬†¬†¬†¬†tiempo: >>¬†sello¬†de¬†tiempo¬†del¬†evento
 *¬†¬†¬†¬†etiqueta: >>¬†etiqueta¬†afectada
 *¬†¬†¬†¬†email: >>¬†email¬†afectado
 *¬†¬†¬†¬†plantilla: >>¬†plantilla¬†afectada
 *¬†¬†¬†¬†mensaje: >>¬†mensaje¬†a¬†registrar¬†}
 */
function¬†actualizarLog(registros)¬†{

  if¬†(registros.map)¬†{
 ¬†¬† const¬†tablaRegistros¬†=¬†registros.reverse().map(registro¬†=>
 ¬†¬†¬†¬†¬†[
 ¬†¬†¬†¬†¬†¬† registro.estado,
 ¬†¬†¬†¬†¬†¬† registro.inicio,
 ¬†¬†¬†¬†¬†¬† registro.tiempo,
 ¬†¬†¬†¬†¬†¬† registro.etiqueta,
 ¬†¬†¬†¬†¬†¬† registro.email,
 ¬†¬†¬†¬†¬†¬† registro.plantilla,
 ¬†¬†¬†¬†¬†¬† registro.mensaje
 ¬†¬†¬†¬†¬†]);
 ¬†¬† const¬†hoja¬†=¬†SpreadsheetApp.getActive().getSheetByName(EMAYORDOMO.tablaLog.nombre);

 ¬†¬† //¬†Inserta¬†las¬†filas¬†necesarias¬†en¬†la¬†parte¬†superior¬†de¬†la¬†tabla,¬†se¬†tiene¬†en¬†cuenta¬†la¬†situaci√≥n¬†inicial¬†(filas¬†vac√≠as)
 ¬†¬† let¬†filasNuevas;
 ¬†¬† if¬†(hoja.getLastRow()¬†<¬†EMAYORDOMO.tablaLog.filInicialDatos)¬†{
 ¬†¬†¬†¬† if¬†(hoja.getMaxRows()¬†-¬†EMAYORDOMO.tablaLog.filInicialDatos¬†+¬†1¬†-¬†tablaRegistros.length¬†>=¬†0)¬†{
 ¬†¬†¬†¬†¬†¬† filasNuevas¬†=¬†0;
 ¬†¬†¬†¬†¬†}¬†else¬†{
 ¬†¬†¬†¬†¬†¬† filasNuevas¬†=¬†tablaRegistros.length¬†-¬†(hoja.getMaxRows()¬†-¬†EMAYORDOMO.tablaLog.filInicialDatos¬†+¬†1);
 ¬†¬†¬†¬†¬†}
 ¬†¬†¬†}¬†else¬†{
 ¬†¬†¬†¬† filasNuevas¬†=¬†tablaRegistros.length;
 ¬†¬†¬†}
 ¬†¬† if¬†(filasNuevas)¬†hoja.insertRowsBefore(EMAYORDOMO.tablaLog.filInicialDatos,filasNuevas);
 ¬†¬† hoja.getRange(EMAYORDOMO.tablaLog.filInicialDatos,¬†1,¬†tablaRegistros.length,¬†tablaRegistros[0].length).setValues(tablaRegistros);
 ¬†};

}
```

Los valores m√°s recientes aparecer√°n siempre en la parte superior de la hoja de c√°lculo. Este es un detalle insignificante pero que facilita comprobar los registros de la actividad reciente de eMayordomo, que aparecer√°n de inmediato al cargar la hoja de c√°lculo. Esto se consigue de dos maneras:

*   Invirtiendo el vector donde se van anotando los eventos durante la ejecuci√≥n de `procesarEmails()` antes de trasladarlo a la hoja de c√°lculo. Esto se hace con ¬†el m√©todo [Array.reverse()](https://developer.mozilla.org/es/docs/Web/JavaScript/Reference/Global_Objects/Array/reverse).
*   Insertado las filas necesarias en parte superior de la tabla para dar cabida a los nuevos eventos a registrar.

# Mejoras y reflexiones finales

eMayordomo ha sido en gran medida un viaje de aprendizaje. Como todos los viajes que merecen la pena. El c√≥digo de este repositorio no pretende ser por tanto un ejemplo de buenas pr√°cticas, solo un reflejo del trabajo realizado y del camino recorrido.

Si tuviera que comenzarlo ahora desde cero, con todo lo aprendido, seguramente adoptar√≠a decisiones de dise√±o distintas.

Y la primera ser√≠a dejar de utilizar el servicio est√°ndar de Gmail para localizar los mensajes a los que se debe responder del modo en que lo he hecho. En lugar de usar [`GmailLabel.getThreads()`](https://developers.google.com/apps-script/reference/gmail/gmail-label#getThreads()) para luego tener que determinar si cada uno de los hilos contiene mensajes destacados y, por si fuera poco, realizar una validaci√≥n final sobre cada mensaje para comprobar si realmente ha sido marcado con la etiqueta perseguida, resulta mucho m√°s pr√°ctico tirar directamente del servicio avanzado / API de Gmail y de su m√©todo [`users.messages.list`](https://developers.google.com/gmail/api/reference/rest/v1/users.messages/list), cuyo par√°metro `q` admite una cadena de b√∫squeda con la que es pan comido obtener los mensajes que hay que procesar en un solo paso y sin ambig√ºedades con las etiquetas. Por ejemplo:

```
label:at-general is:starred 
```

Esta estrategia es probablemente m√°s eficiente que la empleada ahora mismo por eMayordomo, dado que son las tripas de la propia API de Gmail las que se encargan en este caso de todo.

Adem√°s, una peque√±a interfaz de usuario para establecer distintos intervalos de ejecuci√≥n del _trigger_ que procesa el buz√≥n de entrada, presentada en el interior de un [cuadro de di√°logo modal](https://developers.google.com/apps-script/reference/base/ui.html#showModalDialog(Object,String)) o en un [panel lateral](https://developers.google.com/apps-script/reference/base/ui.html#showsidebaruserinterface), resultar√≠a pr√°ctica.

Por otro lado, le he prestado m√°s bien poca atenci√≥n a los [permisos que solicita el script](https://developers.google.com/apps-script/concepts/scopes) (_authorization scopes_), limit√°ndome a aceptar los habitualmente permisivos en exceso que determina el editor Apps Script mientras se va escribiendo el c√≥digo. Si en alg√∫n momento tuviera que salir de eMayordomo un desarrollo m√°s elaborado, o tal vez un complemento publicado en la tienda de aplicaciones, habr√≠a que darle una vuelta a esto.

No puedo dejar de comentar lo cruda que me ha parecido la API de Gmail. Y lo digo fundamentalmente por lo complicado que resulta hacer algo tan aparentemente prosaico como generar un nuevo email a partir de un borrador, cuando aquel contiene im√°genes incrustadas. Las cosas deber√≠an ser m√°s simples, especialmente en una plataforma como Google Apps Script, que est√° muy dirigida a esa llamado _ciudadano desarrollador_.

Pero es que tambi√©n nos encontramos con carencias, como la falta de clases para manipular las plantillas de Gmail (plantillas que, por cierto, se [enumeran como borradores](https://twitter.com/pfelipm/status/1394752800777773057)), o alg√∫n que otro molesto [bug](https://issuetracker.google.com/issues/77320923) como el que afecta al refresco visual de las estrellas de los mensajes destacados, cuando estas se han activado manualmente.

# Licencia

¬© 2021 Pablo Felip Monferrer ([@pfelipm](https://twitter.com/pfelipm)). Se distribuye bajo licencia GNU GPL v3.
